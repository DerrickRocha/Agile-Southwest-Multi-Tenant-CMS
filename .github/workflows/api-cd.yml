name: API CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options: [ dev, prod ]

jobs:
  deploy:
    runs-on: ubuntu-22.04

    environment: ${{ inputs.environment || 'dev' }}

    env:
      AWS_REGION: us-east-1
      APP_NAME: AgileSouthwestCMSAPI

    steps:
      # --------------------------------------------
      # Checkout
      # --------------------------------------------
      - uses: actions/checkout@v4

      # --------------------------------------------
      # Setup .NET
      # --------------------------------------------
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      # --------------------------------------------
      # Publish
      # --------------------------------------------
      - name: Publish API
        run: |
          dotnet publish AgileSouthwestCMSAPI/AgileSouthwestCMSAPI.csproj \
            -c Release \
            -o publish

      # --------------------------------------------
      # Package for Elastic Beanstalk
      # --------------------------------------------
      - name: Zip artifact
        run: |
          cd publish
          zip -r ../app.zip .

      # --------------------------------------------
      # Configure AWS
      # --------------------------------------------
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # --------------------------------------------
      # Upload to S3
      # --------------------------------------------
      - name: Upload to S3
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV_NAME="agilesouthwest-${{ inputs.environment }}"
          else
            ENV_NAME="agilesouthwest-dev"
          fi

          VERSION_LABEL="${GITHUB_SHA}-${ENV_NAME}-$(date +%s)"
          S3_BUCKET="elasticbeanstalk-${AWS_REGION}-${{ secrets.AWS_ACCOUNT_ID }}"
          S3_KEY="api/${VERSION_LABEL}.zip"

          echo "VERSION_LABEL=$VERSION_LABEL" >> $GITHUB_ENV
          echo "S3_KEY=$S3_KEY" >> $GITHUB_ENV

          aws s3 cp app.zip s3://$S3_BUCKET/$S3_KEY

      # --------------------------------------------
      # Deploy to Elastic Beanstalk
      # --------------------------------------------
      - name: Deploy
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name $APP_NAME \
            --version-label $VERSION_LABEL \
            --source-bundle S3Bucket=elasticbeanstalk-${AWS_REGION}-${{ secrets.AWS_ACCOUNT_ID }},S3Key=$S3_KEY

          aws elasticbeanstalk update-environment \
            --environment-name $ENV_NAME \
            --version-label $VERSION_LABEL

