name: API CD

on:
  push:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options: [ dev, prod ]

jobs:
  deploy:
    runs-on: ubuntu-22.04

    # GitHub Environment protection (approvals, secrets)
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'dev' }}

    env:
      AWS_REGION: us-east-1
      APP_NAME: Multi-Tenant-CMS-Development
      S3_BUCKET: elasticbeanstalk-us-east-1-899303943903

    steps:
      # --------------------------------------------
      # Checkout
      # --------------------------------------------
      - uses: actions/checkout@v4

      # --------------------------------------------
      # Setup .NET
      # --------------------------------------------
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      # --------------------------------------------
      # Publish
      # --------------------------------------------
      - name: Publish API
        run: |
          dotnet publish AgileSouthwestCMSAPI/AgileSouthwestCMSAPI.csproj \
            -c Release \
            -o publish

      # --------------------------------------------
      # Package
      # --------------------------------------------
      - name: Zip artifact
        run: |
          cp AgileSouthwestCMSAPI/Procfile publish/Procfile
          cd publish
          zip -r ../app.zip .
      
      # --------------------------------------------
      # Configure AWS Credentials
      # --------------------------------------------
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      # --------------------------------------------
      # Upload bundle to S3
      # --------------------------------------------
      - name: Upload bundle to S3
        run: |
          aws s3 cp app.zip s3://$S3_BUCKET/app-$GITHUB_SHA.zip

      # --------------------------------------------
      # Deploy to Elastic Beanstalk
      # --------------------------------------------
      - name: Deploy
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV_NAME="Multi-Tenant-CMS-env-${{ inputs.environment }}"
          else
            ENV_NAME="Multi-Tenant-CMS-Development-env"
          fi

          VERSION_LABEL="${GITHUB_SHA}-$(date +%s)"

          echo "Deploying $VERSION_LABEL to $ENV_NAME"

          aws elasticbeanstalk create-application-version \
            --application-name $APP_NAME \
            --version-label $VERSION_LABEL \
            --source-bundle S3Bucket=$S3_BUCKET,S3Key=app-$GITHUB_SHA.zip

          aws elasticbeanstalk update-environment \
            --environment-name $ENV_NAME \
            --version-label $VERSION_LABEL




