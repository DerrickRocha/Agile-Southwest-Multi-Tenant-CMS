name: API CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  api-ci:
    runs-on: ubuntu-22.04

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: agile_cms_dev
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      # ------------------------------------------------------------
      # 1️⃣ Checkout API repository
      # ------------------------------------------------------------
      - name: Checkout API repo
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2️⃣ Checkout Database repository
      # ------------------------------------------------------------
      - name: Checkout DB repo
        uses: actions/checkout@v4
        with:
          repository: DerrickRocha/Agile-Southwest-CMS-Database
          path: database

      # ------------------------------------------------------------
      # 3️⃣ Install sqlcmd
      # ------------------------------------------------------------
      - name: Install sqlcmd
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client
          echo "/opt/mssql-tools/bin" >> $GITHUB_PATH

      # ------------------------------------------------------------
      # 5️⃣ Apply database migrations (from DB repo)
      # ------------------------------------------------------------
      - name: Apply database migrations
        run: |
          chmod +x ./database/database/mysql/apply-migrations-ci.sh
          ./database/database/mysql/apply-migrations-ci.sh

      - name: Debug workspace
        run: |
          pwd
          ls -la
          find . -name "*.sln*" -maxdepth 4
      # ------------------------------------------------------------
      # 6️⃣ Build API
      # ------------------------------------------------------------
      - name: Build API
        run: dotnet build AgileSouthwestCMSAPI.slnx --configuration Release

      # ------------------------------------------------------------
      # 7️⃣ Run API tests (against migrated DB)
      # ------------------------------------------------------------
      - name: Run API tests
        env:
          DB_HOST: localhost
          DB_PORT: 1433
          DB_NAME: AppDb
          DB_USER: sa
          DB_PASSWORD: YourStrong!Passw0rd
        run: dotnet test AgileSouthwestCMSAPI.slnx --configuration Release
