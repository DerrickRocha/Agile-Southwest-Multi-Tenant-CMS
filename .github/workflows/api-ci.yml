name: API CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  api-ci:
    runs-on: ubuntu-22.04

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: AppDb
          MYSQL_USER: appuser
          MYSQL_PASSWORD: apppassword
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -prootpassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      # ------------------------------------------------------------
      # 1️⃣ Checkout API repository
      # ------------------------------------------------------------
      - name: Checkout API repo
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2️⃣ Checkout Database repository
      # ------------------------------------------------------------
      - name: Checkout DB repo
        uses: actions/checkout@v4
        with:
          repository: DerrickRocha/Agile-Southwest-CMS-Database
          path: database

      # ------------------------------------------------------------
      # 3️⃣ Install MySQL client
      # ------------------------------------------------------------
      - name: Install MySQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      # ------------------------------------------------------------
      # 4️⃣ Wait for MySQL to be ready
      # ------------------------------------------------------------
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -u root -prootpassword && break
            sleep 2
          done

      # ------------------------------------------------------------
      # 5️⃣ Apply database migrations (from DB repo)
      # ------------------------------------------------------------
      - name: Apply database migrations
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: AppDb
          DB_USER: appuser
          DB_PASSWORD: apppassword
        run: |
          chmod +x ./database/database/mysql/apply-migrations-ci.sh
          ./database/database/mysql/apply-migrations-ci.sh

      # ------------------------------------------------------------
      # 6️⃣ Build API
      # ------------------------------------------------------------
      - name: Build API
        run: dotnet build AgileSouthwestCMSAPI.slnx --configuration Release

      # ------------------------------------------------------------
      # 7️⃣ Run API tests (against migrated DB)
      # ------------------------------------------------------------
      - name: Run API tests
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: AppDb
          DB_USER: appuser
          DB_PASSWORD: apppassword
        run: dotnet test AgileSouthwestCMSAPI.slnx --configuration Release

